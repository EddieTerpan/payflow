üßæ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è –¥–æ –±—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ–∫–∏ –ø–ª–∞—Ç—ñ–∂–Ω–æ—ó —Å–∏—Å—Ç–µ–º–∏
1. –í—Å—Ç—É–ø

–¶–µ–π –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—É—î —Ä–æ–±–æ—Ç—É —Å–∏—Å—Ç–µ–º–∏ –æ–±—Ä–æ–±–∫–∏ –ø–ª–∞—Ç–µ–∂—ñ–≤ —Ç–∞ –º–µ—Ö–∞–Ω—ñ–∑–º —â–æ–¥–µ–Ω–Ω–∏—Ö –≤–∏–ø–ª–∞—Ç –¥–ª—è –º–µ—Ä—á–∞–Ω—Ç–∞. –û–ø–∏—Å –≤–∫–ª—é—á–∞—î –∂–∏—Ç—Ç—î–≤–∏–π —Ü–∏–∫–ª –ø–ª–∞—Ç–µ–∂—É, –ø—Ä–∞–≤–∏–ª–∞ –æ–±—Ä–æ–±–∫–∏ –∫–æ–º—ñ—Å—ñ–π, —Ç–∏–º—á–∞—Å–æ–≤–µ –±–ª–æ–∫—É–≤–∞–Ω–Ω—è D, —á–µ—Ä–≥–æ–≤—ñ—Å—Ç—å –≤–∏–ø–ª–∞—Ç —Ç–∞ –ª–æ–≥—ñ–∫—É —Å—Ç–∞—Ç—É—Å—ñ–≤.

–°–∏—Å—Ç–µ–º–∞ —Å–∫–ª–∞–¥–∞—î—Ç—å—Å—è –∑ —Ç—Ä—å–æ—Ö –æ—Å–Ω–æ–≤–Ω–∏—Ö –µ—Ç–∞–ø—ñ–≤ –æ–±—Ä–æ–±–∫–∏ —Ç–∞ –æ–¥–Ω–æ–≥–æ –µ—Ç–∞–ø—É –≤–∏–ø–ª–∞—Ç, –∫–æ–∂–µ–Ω –∑ —è–∫–∏—Ö –º–æ–∂–µ –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏—Å—è CRON-–ø—Ä–æ—Ü–µ—Å–∞–º–∏ –∞–±–æ –≤—Ä—É—á–Ω—É —á–µ—Ä–µ–∑ API.

2. –°—Ç–∞—Ç—É—Å–∏ –ø–ª–∞—Ç–µ–∂—ñ–≤
   –°—Ç–∞—Ç—É—Å	–û–ø–∏—Å
   ACCEPTED	–ü–ª–∞—Ç—ñ–∂ –ø—Ä–∏–π–Ω—è—Ç–∏–π —ñ –æ—á—ñ–∫—É—î –æ–±—Ä–æ–±–∫–∏
   PROCESSED	–ü–ª–∞—Ç—ñ–∂ –æ–±—Ä–æ–±–ª–µ–Ω–æ: —É—Ç—Ä–∏–º–∞–Ω–æ A+B+C, –∞ —Å—É–º–∞ D —Ç–∏–º—á–∞—Å–æ–≤–æ –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–∞
   COMPLETED	–ü–ª–∞—Ç—ñ–∂ –∑–∞–≤–µ—Ä—à–µ–Ω–æ: —Å—É–º–∞ D —Ä–æ–∑–±–ª–æ–∫–æ–≤–∞–Ω–∞ —ñ –≤–∂–µ –¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è –≤–∏–ø–ª–∞—Ç–∏
   PAID_PENDING	–ü–ª–∞—Ç—ñ–∂ –≤–∏–ø–ª–∞—á–µ–Ω–∏–π —É –º–æ–º–µ–Ω—Ç, –∫–æ–ª–∏ D —â–µ –Ω–µ —Ä–æ–∑–±–ª–æ–∫–æ–≤–∞–Ω–æ
   PAID	–ü–ª–∞—Ç—ñ–∂ –æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤–∏–ø–ª–∞—á–µ–Ω–æ, D –ø–æ–≤–µ—Ä–Ω–µ–Ω–∞ –º–µ—Ä—á–∞–Ω—Ç—É
3. –ö–æ–º—ñ—Å—ñ—ó —Ç–∞ —Ñ—ñ–Ω–∞–Ω—Å–æ–≤—ñ –ø–æ–ª—è

–£ –∫–æ–∂–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂—É —Ä–æ–∑—Ä–∞—Ö–æ–≤—É—é—Ç—å—Å—è —Ç–∞–∫—ñ —Å—É–º–∏:

–ü–æ–ª–µ	–û–ø–∏—Å
feeA	–§—ñ–∫—Å–æ–≤–∞–Ω–∞ –∫–æ–º—ñ—Å—ñ—è A
feeB	–ö–æ–º—ñ—Å—ñ—è –ø–ª–∞—Ç—ñ–∂–Ω–æ—ó —Å–∏—Å—Ç–µ–º–∏ (B%)
feeC	–ö–æ–º—ñ—Å—ñ—è —Å–µ—Ä–≤—ñ—Å—É (C%)
holdD	–¢–∏–º—á–∞—Å–æ–≤–æ –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–∞ —Å—É–º–∞ (D%)
available	–î–æ—Å—Ç—É–ø–Ω–∞ —Å—É–º–∞ –Ω–∞ –ø–æ—Ç–æ—á–Ω–æ–º—É –µ—Ç–∞–ø—ñ
–§–æ—Ä–º—É–ª–∏
–£ —Å—Ç–∞—Ç—É—Å—ñ PROCESSED:
available = amount ‚Äì feeA ‚Äì feeB ‚Äì feeC ‚Äì holdD

–£ —Å—Ç–∞—Ç—É—Å—ñ COMPLETED:
available = amount ‚Äì feeA ‚Äì feeB ‚Äì feeC

–°—É–º–∞, —è–∫–∞ –≤–∏–ø–ª–∞—á—É—î—Ç—å—Å—è –º–µ—Ä—á–∞–Ω—Ç—É:
payoutAmount = amount ‚Äì feeA ‚Äì feeB ‚Äì feeC  (–±–µ–∑ D)

4. –ñ–∏—Ç—Ç—î–≤–∏–π —Ü–∏–∫–ª –ø–ª–∞—Ç–µ–∂—É
   4.1. ACCEPTED ‚Üí PROCESSED

–í–∏–∫–æ–Ω—É—î CRON –∞–±–æ API /payments/process.

–†–æ–∑—Ä–∞—Ö–æ–≤—É—é—Ç—å—Å—è feeA, feeB, feeC, holdD.

–£—Ç—Ä–∏–º—É—î—Ç—å—Å—è –∫–æ–º—ñ—Å—ñ—è.

D —Ç–∏–º—á–∞—Å–æ–≤–æ –±–ª–æ–∫—É—î—Ç—å—Å—è.

–°—Ç–∞–≤–∏–º–æ —Å—Ç–∞—Ç—É—Å PROCESSED.

–û–Ω–æ–≤–ª—é—î—Ç—å—Å—è –ø–æ–ª–µ available.

4.2. PROCESSED ‚Üí COMPLETED

–í–∏–∫–æ–Ω—É—î CRON processProcessed.

–†–æ–∑–º–æ—Ä–æ–∂—É—î–º–æ D.

–î–æ–¥–∞—î–º–æ holdD –≤ available.

–°—Ç–∞–≤–∏–º–æ holdD = 0.

–°—Ç–∞—Ç—É—Å —Å—Ç–∞—î COMPLETED.

–ü–ª–∞—Ç—ñ–∂ —Ç–µ–ø–µ—Ä –ø–æ–≤–Ω—ñ—Å—Ç—é –¥–æ—Å—Ç—É–ø–Ω–∏–π –¥–ª—è –≤–∏–ø–ª–∞—Ç–∏.

4.3. PAID_PENDING ‚Üí PAID

–¢–∞–∫–æ–∂ –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è –≤ CRON processProcessed.

–¶–µ —Ñ—ñ–Ω–∞–ª—å–Ω–µ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è, —è–∫–µ –æ–∑–Ω–∞—á–∞—î:

–ø–ª–∞—Ç—ñ–∂ –±—É–≤ –≤–∏–ø–ª–∞—á–µ–Ω–∏–π —Ä–∞–Ω—ñ—à–µ,

–∞–ª–µ —Ç–æ–¥—ñ —â–µ –Ω–µ –±—É–≤ COMPLETED,

—Ç–µ–ø–µ—Ä D —Ä–æ–∑–º–æ—Ä–æ–∂–µ–Ω–æ,

—Å—Ç–∞—Ç—É—Å –∑–º—ñ–Ω—é—î—Ç—å—Å—è –Ω–∞ PAID.

5. –õ–æ–≥—ñ–∫–∞ —â–æ–¥–µ–Ω–Ω–æ—ó –≤–∏–ø–ª–∞—Ç–∏ (daily payout)

–í–∏–∫–æ–Ω—É—î—Ç—å—Å—è CRON –∞–±–æ API /payouts/run/:merchantId.

–ü—Ä–∞–≤–∏–ª–∞ –∑ –¢–ó

–ü–ª–∞—Ç–µ–∂—ñ —É —Å—Ç–∞—Ç—É—Å—ñ PROCESSED —Ç–∞ COMPLETED –º–∞—é—Ç—å –≤–∏–ø–ª–∞—á—É–≤–∞—Ç–∏—Å—å —Ä–∞–∑ –Ω–∞ –¥–µ–Ω—å
—É –º–µ–∂–∞—Ö –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ –±–∞–ª–∞–Ω—Å—É –∫–ª—ñ—î–Ω—Ç–∞.

–ü–æ—Ä—è–¥–æ–∫ –≤–∏–±–æ—Ä—É –ø–ª–∞—Ç–µ–∂—ñ–≤ –≤–∏–∑–Ω–∞—á–∞—î —Å–∞–º–∞ —Å–∏—Å—Ç–µ–º–∞, –∞–ª–µ –≤—ñ–Ω –º–∞—î –±—É—Ç–∏ —Å—Ç–∞–ª–∏–º.

–Ø–∫—â–æ –ø–ª–∞—Ç—ñ–∂ –≤–∏–ø–ª–∞—á—É—î—Ç—å—Å—è ‚Äî –≤—ñ–Ω –≤–∏–ø–ª–∞—á—É—î—Ç—å—Å—è —è–∫ amount ‚Äì A ‚Äì B ‚Äì C, –∞–ª–µ –ù–ï D.

–ê–ª–≥–æ—Ä–∏—Ç–º

–°–∏—Å—Ç–µ–º–∞ –±–µ—Ä–µ –≤—Å—ñ –ø–ª–∞—Ç–µ–∂—ñ –º–µ—Ä—á–∞–Ω—Ç–∞ —É —Å—Ç–∞—Ç—É—Å–∞—Ö:

COMPLETED

PROCESSED

–°–æ—Ä—Ç—É—î —ó—Ö:

—Å–ø–æ—á–∞—Ç–∫—É COMPLETED (–≤–∏—â–∏–π –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç),

–ø–æ—Ç—ñ–º PROCESSED,

—É –º–µ–∂–∞—Ö —Å—Ç–∞—Ç—É—Å—É ‚Äî FIFO (–ø–æ —á–∞—Å—É —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è).

–û–±—á–∏—Å–ª—é—î –∑–∞–≥–∞–ª—å–Ω–∏–π –¥–æ—Å—Ç—É–ø–Ω–∏–π –±–∞–ª–∞–Ω—Å:

totalAvailable = Œ£ available


–ü—Ä–æ—Ö–æ–¥–∏—Ç—å –ø–æ —á–µ—Ä–∑—ñ –ø–ª–∞—Ç–µ–∂—ñ –π –≤–∏–±–∏—Ä–∞—î —Ç—ñ, —è–∫—ñ –ø–æ–º—ñ—â–∞—é—Ç—å—Å—è —É –±–∞–ª–∞–Ω—Å:

current + payoutAmount <= totalAvailable


–ó–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ —Å—Ç–∞—Ç—É—Å—É:

COMPLETED ‚Üí PAID

PROCESSED ‚Üí PAID_PENDING

–ü–æ–≤–µ—Ä—Ç–∞—î –∑–≤—ñ—Ç:

{
merchantId,
total: —Å—É–º–∞ –≤—Å—ñ—Ö –≤–∏–ø–ª–∞—Ç,
items: —Å–ø–∏—Å–æ–∫ –ø–ª–∞—Ç–µ–∂—ñ–≤ { id, payoutAmount }
}

6. PAID_PENDING ‚Äî –Ω–∞–≤—ñ—â–æ –≤—ñ–Ω –ø–æ—Ç—Ä—ñ–±–µ–Ω?

–¶–µ –æ–±–æ–≤‚Äô—è–∑–∫–æ–≤–∞ –ª–æ–≥—ñ–∫–∞ –∑ —Ç–µ—Ö–∑–∞–≤–¥–∞–Ω–Ω—è.

–ü—Ä–∏–∫–ª–∞–¥ –∑ –¢–ó:

–Ñ –ø–ª–∞—Ç—ñ–∂ PROCESSED –Ω–∞ 100 –≥—Ä–Ω (–∑ —è–∫–∏—Ö 10 –≥—Ä–Ω –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ).
–Ñ –ø–ª–∞—Ç—ñ–∂ COMPLETED –Ω–∞ 10 –≥—Ä–Ω.

–î–æ—Å—Ç—É–ø–Ω–æ –≤—Å—å–æ–≥–æ 100 –≥—Ä–Ω (100-10 + 10).

–°–∏—Å—Ç–µ–º–∞ –º–æ–∂–µ –≤–∏–ø–ª–∞—Ç–∏—Ç–∏:

–ø–ª–∞—Ç—ñ–∂ PROCESSED –Ω–∞ 100 –≥—Ä–Ω
–∞–ª–µ —Ç—ñ–ª—å–∫–∏ —Ü—ñ–Ω–æ—é —Ç–æ–≥–æ, —â–æ D (10 –≥—Ä–Ω) –∑ —Ü—å–æ–≥–æ –ø–ª–∞—Ç–µ–∂—É —â–µ –∑–∞–º–æ—Ä–æ–∂–µ–Ω–∞.

–©–æ —Ü–µ –æ–∑–Ω–∞—á–∞—î?

—Ñ–∞–∫—Ç–∏—á–Ω–æ —Å–∏—Å—Ç–µ–º–∞ —Ç–∏–º—á–∞—Å–æ–≤–æ –±–µ—Ä–µ 10 –≥—Ä–Ω –∑ —ñ–Ω—à–æ–≥–æ –ø–ª–∞—Ç–µ–∂—É / –∑–∞–≥–∞–ª—å–Ω–æ–≥–æ –±–∞–ª–∞–Ω—Å—É

–∫–æ–ª–∏ D —Ä–æ–∑–º–æ—Ä–æ–∑–∏—Ç—å—Å—è ‚Üí —Ü—ñ 10 –≥—Ä–Ω –ø–æ–≤–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞–∑–∞–¥

–¢–æ–º—É –ø–ª–∞—Ç—ñ–∂ —Ç–∏–º—á–∞—Å–æ–≤–æ –º–∞—î —Å—Ç–∞—Ç—É—Å:

üëâ PAID_PENDING

–ê –≤–∂–µ –∫–æ–ª–∏ D —Ä–æ–∑–º–æ—Ä–æ–∑–∏—Ç—å—Å—è —É CRON 2:

üëâ PAID_PENDING ‚Üí PAID.

7. –†–æ–±–æ—Ç–∞ CRON-–ø—Ä–æ—Ü–µ—Å—ñ–≤
   Cron #1 ‚Äî processAccepted (–∫–æ–∂–Ω—ñ 5 —Å–µ–∫—É–Ω–¥)

–±–µ—Ä–µ ACCEPTED

–ø–µ—Ä–µ–≤–æ–¥–∏—Ç—å —É PROCESSED

Cron #2 ‚Äî processProcessed (–∫–æ–∂–Ω—ñ 5 —Å–µ–∫—É–Ω–¥ –∞–±–æ —Ä–∞–∑ —É –≥–æ–¥–∏–Ω—É)

–ø–µ—Ä–µ–≤–æ–¥–∏—Ç—å PROCESSED ‚Üí COMPLETED

–ø–µ—Ä–µ–≤–æ–¥–∏—Ç—å PAID_PENDING ‚Üí PAID

Cron #3 ‚Äî daily payout (—Ä–∞–∑ —É –¥–æ–±—É)

–±–µ—Ä–µ –≤—Å—ñ COMPLETED + PROCESSED

–≤–∏–∫–æ–Ω—É—î –≤–∏–ø–ª–∞—Ç—É

–≤–∏—Å—Ç–∞–≤–ª—è—î PAID —Ç–∞ PAID_PENDING

8. –ó–≤–µ–¥–µ–Ω–∞ –¥—ñ–∞–≥—Ä–∞–º–∞ —Å—Ç–∞—Ç—É—Å—ñ–≤
   ACCEPTED
   ‚îÇ processAccepted
   ‚ñº
   PROCESSED
   ‚îÇ dailyPayout (–º–æ–∂–µ –±—É—Ç–∏ –≤–∏–ø–ª–∞—á–µ–Ω–∏–π —Ä–∞–Ω—ñ—à–µ)
   ‚îÇ         ‚îî‚îÄ‚îÄ‚Üí PAID_PENDING
   ‚îÇ processProcessed
   ‚ñº
   COMPLETED
   ‚îÇ dailyPayout
   ‚ñº
   PAID

9. –§—ñ–Ω–∞–ª—å–Ω–∏–π –≤–∏—Å–Ω–æ–≤–æ–∫

–û–ø–∏—Å–∞–Ω–∞ –ª–æ–≥—ñ–∫–∞ –ø–æ–≤–Ω—ñ—Å—Ç—é –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î –¢–ó:

‚úî PROCESSED –Ω–µ –º–æ–∂–µ –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞–ø—Ä—è–º—É —É PAID
‚úî D –ø—Ä–∞–≤–∏–ª—å–Ω–æ –±–ª–æ–∫—É—î—Ç—å—Å—è —ñ —Ä–æ–∑–º–æ—Ä–æ–∂—É—î—Ç—å—Å—è
‚úî PAID_PENDING –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è —Å–∞–º–µ —É —Ç–∏—Ö –≤–∏–ø–∞–¥–∫–∞—Ö, –∫–æ–ª–∏ –ø–ª–∞—Ç—ñ–∂ –≤–∏–ø–ª–∞—á–µ–Ω–æ –¥–æ —Ä–æ–∑–º–æ—Ä–æ–∂–µ–Ω–Ω—è D
‚úî –î–æ—Å—Ç—É–ø–Ω–∏–π –±–∞–ª–∞–Ω—Å —Ä–æ–∑—Ä–∞—Ö–æ–≤—É—î—Ç—å—Å—è —Å—Ç—Ä–æ–≥–æ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ –¢–ó
‚úî –ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç COMPLETED –ø–µ—Ä–µ–¥ PROCESSED –¥–æ—Ç—Ä–∏–º–∞–Ω–∏–π
‚úî –ü–æ–≤–Ω–∏–π —Ñ–ª–æ—É –≥–∞—Ä–∞–Ω—Ç–æ–≤–∞–Ω–æ –∑–∞–ø–æ–±—ñ–≥–∞—î –æ–≤–µ—Ä–¥—Ä–∞—Ñ—Ç—É